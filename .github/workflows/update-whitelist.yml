name: Update Whitelist
on:
  schedule:
    - cron: '0 0 * * 0' # Chạy vào 00:00 Chủ nhật hàng tuần
  workflow_dispatch:      # Cho phép bạn bấm nút chạy thủ công bất cứ lúc nào

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch and Clean IPs
        run: |
          # Tạo file tạm
          touch raw.txt
          
          # 1. Tải Cloudflare
          curl -s https://www.cloudflare.com/ips-v4 >> raw.txt
          curl -s https://www.cloudflare.com/ips-v6 >> raw.txt
          
          # 2. Tải OpenAI (GPTBot)
          curl -s https://openai.com/gptbot.json | jq -r '.prefixes[] | .ipv4Prefix // .ipv6Prefix' >> raw.txt
          
          # 3. Tải Jetpack
          curl -s -L -A "Mozilla/5.0" https://jetpack.com/ips-v4.txt >> raw.txt
          curl -s -L -A "Mozilla/5.0" https://jetpack.com/ips-v6.txt >> raw.txt

          # Làm sạch: Lọc đúng định dạng IP, xóa trùng, sắp xếp
          grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}(/[0-9]{1,2})?|([0-9a-fA-F]{1,4}:){2,7}[0-9a-fA-F]{1,4}(/[0-9]{1,3})?' raw.txt | sort -u > official-whitelist.conf
          
      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add official-whitelist.conf
          git commit -m "Update whitelist $(date)" || exit 0
          git push
